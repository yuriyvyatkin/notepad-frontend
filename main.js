(()=>{"use strict";class e{constructor(e,s,t,a,n){this.baseURL=e,this.loading=s,this.messagesContainer=t,this.messages=a,this.notepadInput=n}getBaseURL(){return this.baseURL}preConnection(){fetch(`${this.baseURL}/check`).then((()=>{this.loading.classList.remove("active")}),(()=>{this.preConnection()}))}showWarning(){this.messagesContainer.classList.add("api-says","request-execution"),this.messagesContainer.dataset.apiMessage="Подождите, выполняется запрос к серверу..."}activateAPI(){this.messagesContainer.classList.add("api-says")}getMessages(e,s){this.activateAPI(),this.showWarning(),this.messages.childElementCount>0&&(this.messagesContainer.style.overflowY="clip"),fetch(`${this.baseURL}/messages?amountChildren=${e}`).then((e=>this.handleSuccess(e,s)),(e=>this.handleRejection(e)))}getBlob(e,s){this.showWarning(),fetch(`${this.baseURL}${e}`).then((e=>this.handleSuccess(e,s)),(e=>this.handleRejection(e)))}uploadMessage(e,s,t,a){let n;this.showWarning();let o,i;try{"object"==typeof t?(n=new FormData,n.append("file",t),n.append("type",a),n.append("name",t.name),n.append("coords",JSON.stringify(e)),n.append("timestamp",s),i=e=>{e.json().then((e=>{this.messages.lastElementChild.id=e.id,this.messages.lastElementChild.dataset.link=e.link}))}):"string"==typeof t&&(n=JSON.stringify({type:a,content:t,coords:e,timestamp:s}),o={"Content-Type":"application/json"},i=e=>{e.text().then((e=>{this.messages.lastElementChild.id=e}))})}catch(e){throw this.outputError("Ошибка при подготовке данных для отправки!"),e}fetch(`${this.baseURL}/messages`,{body:n,method:"POST",headers:o}).then((e=>this.handleSuccess(e,i)),(e=>this.handleRejection(e)))}changeMessage(e,s){this.activateAPI();const t=new URLSearchParams;t.append("id",e),t.append("changedOption",s);fetch(`${this.baseURL}/messages`,{body:t,method:"PATCH",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then((e=>this.handleSuccess(e)),(e=>this.handleRejection(e)))}handleSuccess(e,s){s&&s(e),this.messagesContainer.classList.remove("api-says"),this.messagesContainer.dataset.apiMessage="",this.notepadInput.focus()}handleRejection(e){"Failed to fetch"===e.message?this.outputError("Сервер не доступен, передача данных остановлена!"):this.outputError(`Ошибка: ${e}! Передача данных остановлена.`)}outputError(e){this.messages.childElementCount>0&&(this.messagesContainer.style.overflowY="auto"),this.messagesContainer.classList.remove("request-execution"),this.messagesContainer.dataset.apiMessage=e,this.messagesContainer.classList.add("api-says","error"),setTimeout((()=>{this.messagesContainer.dataset.apiMessage="",this.messagesContainer.classList.remove("api-says","error")}),3e3)}}const s=document.querySelector(".notepad-widget"),t=s.querySelector(".notepad-widget__messages-container"),a=s.querySelector(".notepad-widget__messages"),n=s.querySelector(".notepad-widget__input"),o=document.querySelector(".status-loading"),i="notepad-backend-d3cf5990ad0d.herokuapp.com",r=new e(`https://${i}`,o,t,a,n);r.preConnection();const l=new WebSocket(`wss://${i}`),d=new class{constructor(e,s,t,a,n){this.notepadInput=e,this.messages=s,this.messagesContainer=t,this.api=a,this.ws=n}static getTime(){const e=new Date;return new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"}).format(e).replace(/\d{2}(\d{2}),/,"$1")}static addLinks(e){return e.replace(/((https?:)(\/\/\/?)([\w]*(?::[\w]*)?@)?([\d\w.-]+)(?::(\d+))?([/\\\w.()-]*)?(?:([?][^#]*)?(#.*)?)*)/gi,'<a href="$1" target="_blank">$1</a>')}getMessageHTML(e){const{id:s,type:t,name:a,content:n,link:o,coords:i,timestamp:r,pinned:l,favorite:d}=e;let c;o&&(c=o.startsWith("blob")?o:`${this.api.getBaseURL()}/${o}`);let h=`<div class="message ${d?"favorite":""}" data-type="${t}" id="${s}" ${l?'data-state="pinned"':""}>`;h+="image"===t?`\n        <div class="message__thumbnail">\n          <h3 class="message__thumbnail-label">${a}</h3>\n          <img src="${c}" alt="#">\n        </div>\n      `:"video"===t?`\n        <div class="message__thumbnail">\n          <h3 class="message__thumbnail-label">${a}</h3>\n          <video src="${c}" controls>Your browser does not support the video tag.</video>\n        </div>\n      `:"audio"===t?`\n        <div class="message__thumbnail">\n          <h3 class="message__thumbnail-label">${a}</h3>\n          <audio src="${c}" controls>Your browser does not support the audio element.</audio>\n        </div>\n      `:`<div class="message__text">${this.constructor.addLinks(n)}</div>`;let p="";return 0!==i.lat&&0!==i.lon&&(p=`\n        <span class="message__coordinates">[${parseInt(1e5*i.lat,10)/1e5}, ${parseInt(1e5*i.lon,10)/1e5}]</span>\n        <a class="message__google-maps-link" href="http://www.google.com/maps/place/${i.lat},${i.lon}" target="_blank">&#128065;</a>\n      `),h+=`\n        <div class="message__footer">\n          ${p}\n          ${"text"!==t?`<a class="message__download-link" href="${c}" download="${a}">&#11123;</a>`:""}\n          <a class="message__pin" href="#">&#128392;</a>\n          <a class="message__star" href="#">&#9733;</a>\n          <span class="message__timestamp">${r.replace(" "," | ")}</span>\n        </div>\n      </div>\n    `,h}addMessage(e,s,t){const a=this.constructor.getTime();let n;"text"!==t&&(n=URL.createObjectURL(s));const o={type:t,name:s.name,content:s,link:n,coords:e,timestamp:a};1===this.ws.readyState&&this.ws.send(JSON.stringify(o));const i=this.getMessageHTML(o);this.messages.insertAdjacentHTML("beforeend",i),setTimeout((()=>{this.messagesContainer.scrollTo(0,this.messagesContainer.scrollHeight)}),300),this.notepadInput.value="",this.notepadInput.dataset.geoResponse="",this.notepadInput.focus(),this.api.uploadMessage(e,a,s,t)}}(n,a,t,r,l),c=new class extends e{constructor(e,s,t,a){super(),this.ws=e,this.messages=s,this.messagesContainer=t,this.notepadMessagesMaker=a}handleIncomingMessages(){this.ws.addEventListener("message",(e=>{const s=JSON.parse(e.data),t=this.notepadMessagesMaker.getMessageHTML(s);this.messages.insertAdjacentHTML("beforeend",t),this.messagesContainer.scrollTo(0,this.messagesContainer.scrollHeight)}))}handleServerDisconnection(){this.ws.addEventListener("close",(()=>{this.outputError("Сервер отключен, передача данных остановлена!")}))}}(l,a,t,d);c.handleIncomingMessages(),c.handleServerDisconnection();const h=document.querySelector(".drop-zone__input"),p=document.querySelector(".modal"),g=p.querySelector(".modal__header"),m=p.querySelector(".modal__message"),u=p.querySelector(".modal__form"),v=p.querySelector(".modal-form__input"),f=p.querySelector(".modal-form__button-cancel"),L=new class{constructor(e,s,t,a,n,o,i,r,l){this.modalWindow=e,this.modalHeader=s,this.modalMessage=t,this.modalForm=a,this.modalFormInput=n,this.modalCancelButton=o,this.notepadInput=i,this.dropZoneInput=r,this.notepadMessagesMaker=l}setContent(e){this.modalHeader.textContent=e.header,this.modalMessage.textContent=e.message}toggle(){this.modalWindow.classList.toggle("active")}getCoords(){const e=this.modalFormInput.value.replace(/^\[/,"").replace(/\]$/,"").replace(/, /,","),[s,t]=e.split(",");return{lat:+s,lon:+t}}checkModalFormInput(){return/^\[?[−-]?([0-9]|[1-8][0-9])(\.\d{1,5})?,\s?[−-]?([0-9]|[1-9][0-9]|[1][0-7][0-9])(\.\d{1,5})?\]?$/.test(this.modalFormInput.value)}static manageValidity(e,s){e?s.setCustomValidity(""):s.setCustomValidity("Координаты не соответствуют примеру")}assignInputCheckerHandler(){this.modalFormInput.addEventListener("change",(()=>this.constructor.manageValidity(this.checkModalFormInput(),this.modalFormInput))),this.modalFormInput.addEventListener("input",(()=>this.constructor.manageValidity(this.checkModalFormInput(),this.modalFormInput)))}assignSubmitHandler(){this.modalForm.addEventListener("submit",(e=>{if(e.preventDefault(),this.checkModalFormInput()){if(this.toggle(),this.notepadInput.value)this.notepadMessagesMaker.addMessage(this.getCoords(),this.notepadInput.value,"text");else{const e=this.dropZoneInput.files[0],s=e.type.replace(/(^[a-z]+)\/.+/,"$1");this.notepadMessagesMaker.addMessage(this.getCoords(),e,s)}this.modalHeader.textContent="",this.modalMessage.textContent="",this.modalForm.reset()}else this.modalFormInput.setCustomValidity("Координаты не соответствуют примеру")}))}assignCancelHandler(){this.modalCancelButton.onclick=()=>{this.notepadInput.focus(),this.notepadInput.selectionStart=this.notepadInput.value.length,this.toggle(),this.modalHeader.textContent="",this.modalMessage.textContent="",this.modalForm.reset()}}}(p,g,m,u,v,f,n,h,d);L.assignInputCheckerHandler(),L.assignSubmitHandler(),L.assignCancelHandler();const y=new class{constructor(e,s){this.notepadInput=e,this.modal=s}setGeoResponse(){this.notepadInput.closest("form").classList.add("form_hidden"),navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>this.handleSuccess(e)),(e=>this.handleRejection(e))):this.notepadInput.dataset.geoResponse=JSON.stringify({header:"Ваш браузер не поддерживает геолокацию",message:"Смените браузер, либо введите местоположение (широту и долготу) в ручную."})}call(e){this.setGeoResponse();const s=setInterval((()=>{if(this.notepadInput.dataset.geoResponse){const t=JSON.parse(this.notepadInput.dataset.geoResponse);this.notepadInput.closest("form").classList.remove("form_hidden"),t.success?(delete t.success,e(t)):(this.modal.setContent(t),this.modal.toggle()),clearInterval(s)}}),300)}handleSuccess(e){this.notepadInput.dataset.geoResponse=JSON.stringify({success:!0,lat:e.coords.latitude,lon:e.coords.longitude})}handleRejection(e){const s={header:"",message:""};switch(e.code){case e.PERMISSION_DENIED:s.header="Настройками текущего браузера запрещен запрос геолокации",s.message="Измените настройки конфиденциальности, либо введите местоположение (широту и долготу) в ручную.";break;case e.POSITION_UNAVAILABLE:s.header="Информация о вашем местоположении недоступна",s.message="Введите местоположение в ручную.";break;case e.TIMEOUT:s.header="Истекло время ожидания запроса вашего местоположения",s.message='Нажмите "Отмена" и попробуйте ещё раз, либо введите местоположение (широту и долготу) в ручную.';break;default:s.header="Произошла неизвестная ошибка",s.message='Нажмите "Отмена" и попробуйте ещё раз, либо введите местоположение (широту и долготу) в ручную.'}this.notepadInput.dataset.geoResponse=JSON.stringify(s)}}(n,L),_=t,C=document.querySelector(".paperclip"),I=document.querySelector(".geolocation-toggler"),M=new class{constructor(e,s,t,a,n,o){this.dropZone=e,this.dropZoneInput=s,this.paperclip=t,this.geolocation=a,this.geoToggler=n,this.notepadMessagesMaker=o}handleReceivedFile(e){const s=e.type.replace(/(^[a-z]+)\/.+/,"$1");if(!["image","video","audio"].includes(s))return this.dropZone.classList.add("extension-error"),void setTimeout((()=>{this.dropZone.classList.remove("drop-zone-overlay","extension-error")}),3e3);this.dropZone.classList.remove("drop-zone-overlay"),this.geoToggler.checked?this.geolocation.call((t=>{this.notepadMessagesMaker.addMessage(t,e,s)})):this.notepadMessagesMaker.addMessage({lat:0,lon:0},e,s)}handleDropZoneInput(){this.paperclip.addEventListener("click",(()=>{this.dropZoneInput.click()})),this.dropZoneInput.addEventListener("click",(e=>{const{target:s}=e;s.value=null})),this.dropZoneInput.addEventListener("change",(e=>{const{currentTarget:s}=e;if(s.files.length){const e=s.files[0];this.handleReceivedFile(e)}}))}handleDropZone(){this.dropZone.addEventListener("dragover",(e=>{e.preventDefault(),e.target.closest(".notepad-widget__messages-container")&&(this.dropZone.classList.add("drop-zone-overlay"),this.dropZone.scrollTo(0,this.dropZone.scrollHeight))})),["dragleave","dragend"].forEach((e=>{this.dropZone.addEventListener(e,(e=>{null!==e.relatedTarget&&e.relatedTarget.className===e.currentTarget.className||e.currentTarget.classList.remove("drop-zone-overlay")}))})),this.dropZone.addEventListener("drop",(e=>{if(e.preventDefault(),e.dataTransfer.files.length){this.dropZoneInput.files=e.dataTransfer.files;const s=e.dataTransfer.files[0];this.handleReceivedFile(s)}}))}}(_,h,C,y,I,d);M.handleDropZoneInput(),M.handleDropZone(),n.addEventListener("keyup",(e=>function(e,s,t,a,n){if("Enter"===e.key){const{value:e}=s;if(!e||!e.trim())return void s.setAttribute("value","");n.checked?a.call((s=>{t.addMessage(s,e,"text")})):t.addMessage({lat:0,lon:0},e,"text")}}(e,n,d,y,I)));document.querySelector(".notepad__form").addEventListener("submit",(e=>e.preventDefault()));const w=new class{constructor(e,s,t){this.messagesContainer=e,this.messages=s,this.api=t}assignHandler(){this.messages.addEventListener("click",(e=>{const{target:s}=e;if(s.classList.contains("message__download-link")&&!s.href.startsWith("blob")){e.preventDefault();const t=e=>{e.blob().then((e=>{s.href=URL.createObjectURL(e),s.click()}))},a=new URL(s.href);this.api.getBlob(a.pathname,t)}else if(s.classList.contains("message__pin")){const e=s.closest(".message");if(this.messages.classList.contains("with-pinned-child")||e.classList.contains("pinned"))e.classList.contains("pinned")&&(e.style="",s.removeAttribute("aria-disabled"),e.classList.remove("pinned"),this.messages.classList.remove("with-pinned-child"),this.api.changeMessage(e.id,"pinned"));else{const t=this.messagesContainer.offsetWidth-this.messagesContainer.clientWidth;e.style.transform=`translateX(calc(-50% - ${t/2}px))`,s.setAttribute("aria-disabled","true"),s.removeAttribute("data-state"),e.classList.add("pinned"),this.messages.classList.add("with-pinned-child"),this.api.changeMessage(e.id,"pinned")}}else if(s.classList.contains("message__star")){const e=s.closest(".message");e.classList.toggle("favorite"),this.api.changeMessage(e.id,"favorite")}}))}}(t,a,r);function b(e){e.json().then((e=>{let s="";e.body.forEach((e=>{s+=d.getMessageHTML(e)})),a.insertAdjacentHTML("afterbegin",s);const o=a.querySelector('[data-state="pinned"]');if(o){o.querySelector(".message__pin").click()}e.rest<=0&&a.classList.remove("lazy-loading"),t.style.overflowY="auto",n.focus()}))}w.assignHandler(),r.getMessages(0,(e=>b(e))),t.dataset.oldScroll=t.scrollTop,t.addEventListener("scroll",(e=>{const{currentTarget:s}=e,t=parseFloat(s.dataset.oldScroll);if(a.classList.contains("lazy-loading")&&t>s.scrollTop){const e=(s.scrollHeight-s.clientHeight)/4;s.scrollTop<e&&r.getMessages(a.childElementCount,(e=>b(e)))}s.dataset.oldScroll=s.scrollTop}));const S=s.querySelector(".side-nav").querySelectorAll("a"),k=new class{constructor(e,s,t){this.controls=e,this.messages=s,this.messagesContainer=t}handleClick(){this.controls.forEach((e=>{const s=e.className;e.addEventListener("click",(e=>{e.currentTarget.parentElement.classList.toggle("activated"),this.messages.classList.toggle(`only-${s}`),e.currentTarget.classList.toggle("active"),this.messagesContainer.scrollTo(0,this.messagesContainer.scrollHeight)}))}))}}(S,a,t);k.handleClick(),setTimeout((()=>{!function(e,s){const t=setInterval((()=>{e.scrollBy(0,75);const a=parseFloat(e.dataset.oldScroll);0!==s.childElementCount&&e.scrollTop>0&&a===e.scrollTop?clearInterval(t):e.setAttribute("oldScroll",e.scrollTop)}),100)}(t,a)}),1e3)})();